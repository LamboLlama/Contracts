<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Presale.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Presale.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>47/47</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">96.3% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>52/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>77/77</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">137×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">136×</span>
<span class="cline-any cline-yes">135×</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-yes">133×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">76×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">116×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">72×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity 0.8.22;
&nbsp;
// Importing necessary OpenZeppelin contracts and libraries
import {ECDSA} from "@openzeppelin/contracts/utils/cryptography/ECDSA.sol"; // For signature verification
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol"; // ERC20 interface
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol"; // Provides basic access control
import {ReentrancyGuard} from "@openzeppelin/contracts/security/ReentrancyGuard.sol"; // Protects against reentrancy attacks
&nbsp;
/**
 * @title Presale Contract
 * @dev This contract manages a token presale with bonus thresholds and vesting for bonus tokens.
 * Users can contribute ETH during the presale period and claim their tokens after the claim period starts.
 * The contract supports a whitelist for early contributions and applies bonuses based on contribution thresholds.
 */
contract Presale is Ownable, ReentrancyGuard {
    /// @dev Structure to store each contributor's information
    struct Contribution {
        uint256 amount; // Actual ETH invested by the user
        uint256 effectiveAmount; // Effective ETH after applying bonuses
        uint256 claimedBonusTokens; // Bonus tokens already claimed by the user
        bool claimed; // Whether the user has claimed their initial tokens
    }
&nbsp;
    // Custom errors for more gas-efficient error handling
&nbsp;
    error TransferFailed(); // Thrown when ETH transfer to treasury wallet fails
    error LowContribution(); // Thrown when ETH sent does not meet the minimum contribution
    error AlreadyDeposited(); // Thrown when tokens have already been deposited
    error InvalidWalletInput(); // Thrown when an invalid wallet address is provided
    error InvalidPresaleClaimInput(); // Thrown when presale claim time is invalid
    error InvalidPresaleInput(); // Thrown when presale parameters are invalid
    error InvalidWhitelistInput(); // Thrown when whitelist parameters are invalid
    error NotWhitelisted(); // Thrown when a user is not whitelisted
    error ClaimPeriodNotStarted(); // Thrown when claim period hasn't started yet
    error NoContributionsToClaim(); // Thrown when a user has no contributions to claim
    error NotInContributionPeriod(); // Thrown when contributions are made outside the allowed period
&nbsp;
    /// @notice Emitted when tokens are deposited into the contract
    /// @param amount The amount of tokens deposited
    event TokensDeposited(uint256 amount);
&nbsp;
    /// @notice Emitted when a user makes a contribution
    /// @param user The address of the contributor
    /// @param amount The amount of ETH contributed
    /// @param effectiveAmount The effective amount after applying bonuses
    event ContributionReceived(address indexed user, uint256 amount, uint256 effectiveAmount);
&nbsp;
    /// @notice Emitted when a user claims their initial tokens
    /// @param user The address of the user
    /// @param amount The amount of tokens claimed
    event TokensClaimed(address indexed user, uint256 amount);
&nbsp;
    /// @notice Emitted when a user claims their bonus tokens
    /// @param user The address of the user
    /// @param amount The amount of bonus tokens claimed
    event BonusTokensClaimed(address indexed user, uint256 amount);
&nbsp;
    // Constants for percentage calculations
    uint256 private constant ONE_PERCENT = 10 ** 27; // Represents 1% in fixed-point arithmetic
    uint256 private constant ONE_HUNDRED_PERCENT = 100 * ONE_PERCENT; // Represents 100%
&nbsp;
    /// @notice The ERC20 token being sold
    IERC20 public token;
&nbsp;
    /// @notice Indicates whether tokens have been deposited into the contract
    bool public tokensDeposited;
&nbsp;
    /// @notice Total number of tokens allocated for the presale
    uint256 public presaleSupply;
&nbsp;
    /// @notice Total actual ETH collected from contributors
    uint256 public totalEth;
&nbsp;
    /// @notice Total effective ETH after applying bonuses
    uint256 public totalEthEffective;
&nbsp;
    /// @notice Start time for the whitelist contribution period
    uint256 public whitelistStartTime;
&nbsp;
    /// @notice End time for the whitelist contribution period
    uint256 public whitelistEndTime;
&nbsp;
    /// @notice Start time for the public presale
    uint256 public publicPresaleStartTime;
&nbsp;
    /// @notice End time for the public presale
    uint256 public publicPresaleEndTime;
&nbsp;
    /// @notice Start time when token claims can begin
    uint256 public presaleClaimStartTime;
&nbsp;
    /// @notice End time for the vesting period of bonus tokens
    uint256 public presaleVestingEndTime;
&nbsp;
    /// @notice Array of bonus rates corresponding to thresholds
    uint256[] public bonusRates;
&nbsp;
    /// @notice Array of ETH thresholds for bonus rates
    uint256[] public bonusThresholds;
&nbsp;
    /// @notice Mapping of contributions by user address
    mapping(address =&gt; Contribution) public contributions;
&nbsp;
    /// @notice Address of the treasury wallet where collected ETH is sent
    address public treasuryWallet;
&nbsp;
    /// @notice Address of the signer for whitelist verification
    address public whitelistSigner;
&nbsp;
    /// @dev Modifier to ensure the function is called after the claim period has started
    modifier afterClaimStart() {
        if (block.timestamp &lt;= presaleClaimStartTime) revert ClaimPeriodNotStarted();
        _;
    }
&nbsp;
    /**
     * @notice Constructor to initialize the presale contract
     * @param _token The ERC20 token being sold
     * @param _presaleSupply The total number of tokens allocated for the presale
     * @param _whitelistSigner The address of the whitelist signer
     * @param _treasuryWallet The address of the treasury wallet to receive ETH
     * @param _whitelistStartTime The start time for the whitelist contribution period
     * @param _whitelistEndTime The end time for the whitelist contribution period
     * @param _publicPresaleStartTime The start time for the public presale
     * @param _publicPresaleEndTime The end time for the public presale
     * @param _presaleClaimStartTime The start time when token claims can begin
     */
    constructor(
        IERC20 _token,
        uint256 _presaleSupply,
        address _whitelistSigner,
        address payable _treasuryWallet,
        uint256 _whitelistStartTime,
        uint256 _whitelistEndTime,
        uint256 _publicPresaleStartTime,
        uint256 _publicPresaleEndTime,
        uint256 _presaleClaimStartTime
    ) {
        // Validate treasury wallet address
        if (_treasuryWallet == address(0)) revert InvalidWalletInput();
&nbsp;
        // Validate whitelist and presale times
        if (_whitelistEndTime &lt; _whitelistStartTime) revert InvalidWhitelistInput();
        if (_publicPresaleStartTime &lt; _whitelistEndTime) revert InvalidWhitelistInput();
        if (_publicPresaleEndTime &lt; _publicPresaleStartTime) revert InvalidPresaleInput();
        if (_presaleClaimStartTime &lt; _publicPresaleEndTime) revert InvalidPresaleClaimInput();
&nbsp;
        // Initialize state variables
        token = _token;
        presaleSupply = _presaleSupply;
&nbsp;
        treasuryWallet = _treasuryWallet;
        whitelistSigner = _whitelistSigner;
&nbsp;
        publicPresaleStartTime = _publicPresaleStartTime;
        publicPresaleEndTime = _publicPresaleEndTime;
&nbsp;
        whitelistStartTime = _whitelistStartTime;
        whitelistEndTime = _whitelistEndTime;
&nbsp;
        presaleClaimStartTime = _presaleClaimStartTime;
        presaleVestingEndTime = presaleClaimStartTime + 30 days; // Vesting ends 30 days after claim start
&nbsp;
        // Initialize bonus thresholds and rates
        bonusRates = [
            uint256(40) * ONE_PERCENT, // 40% bonus rate
            uint256(30) * ONE_PERCENT, // 30% bonus rate
            uint256(15) * ONE_PERCENT, // 15% bonus rate
            0 // 0% bonus rate beyond thresholds
        ];
        bonusThresholds = [5 ether, 10 ether, 20 ether]; // Bonus thresholds at 5 ETH, 10 ETH, and 20 ETH
    }
&nbsp;
    /**
     * @notice Allows the owner to deposit tokens into the contract for the presale
     */
    function depositTokens() external onlyOwner {
        if (tokensDeposited) revert AlreadyDeposited();
        token.transferFrom(msg.sender, address(this), presaleSupply);
        tokensDeposited = true;
        emit TokensDeposited(presaleSupply);
    }
&nbsp;
    /**
     * @notice Checks if an address is whitelisted
     * @param signature The signature provided by the user
     * @return bool indicating whether the user is whitelisted
     */
    function isWhitelisted(bytes memory signature) public view returns (bool) {
        // Recreate the signed message hash
        bytes32 messageHash = keccak256(abi.encodePacked(msg.sender));
        bytes32 ethSignedMessageHash = ECDSA.toEthSignedMessageHash(messageHash);
&nbsp;
        // Verify the signature
        return ECDSA.recover(ethSignedMessageHash, signature) == whitelistSigner;
    }
&nbsp;
    /**
     * @notice Allows users to contribute ETH during the presale period
     * @param signature The signature for whitelist verification during the whitelist period
     */
    function contribute(bytes memory signature) public payable <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        if (msg.value == 0) {
            revert LowContribution(); // Ensure no dust eth is sent
        }
&nbsp;
        // Check if contribution is within allowed time frames
        if (block.timestamp &lt; whitelistStartTime || block.timestamp &gt; publicPresaleEndTime) {
            revert NotInContributionPeriod();
        }
&nbsp;
        // If within whitelist period, verify signature
        if (block.timestamp &lt;= whitelistEndTime) {
            if (signature.length == 0 || !isWhitelisted(signature)) {
                revert NotWhitelisted();
            }
        }
&nbsp;
        uint256 remainingDeposit = msg.value; // Remaining ETH to process
        uint256 effectiveAmount = 0; // Total effective amount after bonuses
&nbsp;
        // Iterate through bonus thresholds and apply bonuses
        for (uint256 i = 0; i &lt; bonusThresholds.length; i++) {
            if (remainingDeposit == 0 || totalEth &gt;= bonusThresholds[i]) {
                // If no remaining ETH to process or we've exceeded the threshold, break
                continue;
            }
&nbsp;
            uint256 thresholdAmount = bonusThresholds[i] - totalEth;
            uint256 amountInThisThreshold = remainingDeposit &lt;= thresholdAmount
                ? remainingDeposit
                : thresholdAmount; // Calculate how much ETH can be processed in this threshold
            uint256 bonusAmount = (amountInThisThreshold * bonusRates[i]) / ONE_HUNDRED_PERCENT; // Calculate bonus
&nbsp;
            effectiveAmount += amountInThisThreshold + bonusAmount; // Update effective amount
            remainingDeposit -= amountInThisThreshold; // Update remaining deposit
            totalEth += amountInThisThreshold; // Update total ETH collected
        }
&nbsp;
        // Any remaining deposit beyond thresholds gets no bonus
        if (remainingDeposit &gt; 0) {
            effectiveAmount += remainingDeposit; // Add remaining deposit to effective amount
            totalEth += remainingDeposit; // Update total ETH collected
        }
&nbsp;
        totalEthEffective += effectiveAmount; // Update total effective ETH
&nbsp;
        // Update user's contribution
        Contribution storage userContribution = contributions[msg.sender];
        userContribution.amount += msg.value; // Update actual amount contributed
        userContribution.effectiveAmount += effectiveAmount; // Update effective amount
&nbsp;
        // Transfer the contributed ETH to the treasury wallet
        (bool success, ) = treasuryWallet.call{value: msg.value}("");
        if (!success) {
            revert TransferFailed(); // Revert if transfer fails
        }
&nbsp;
        emit ContributionReceived(msg.sender, msg.value, effectiveAmount); // Emit event
    }
&nbsp;
    /**
     * @notice Allows users to claim their tokens after the claim period has started
     */
    function claim() external afterClaimStart <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        Contribution storage userContribution = contributions[msg.sender];
        if (userContribution.amount == 0 &amp;&amp; userContribution.effectiveAmount == 0)
            revert NoContributionsToClaim(); // Ensure the user has contributions to claim
&nbsp;
        // Claim initial tokens if not already claimed
        if (!userContribution.claimed) {
            // Calculate the amount of tokens to distribute immediately
            uint256 userAmountTokens = (userContribution.amount * presaleSupply) /
                totalEthEffective;
&nbsp;
            userContribution.claimed = true; // Mark as claimed
&nbsp;
            token.transfer(msg.sender, userAmountTokens); // Transfer tokens to the user
&nbsp;
            emit TokensClaimed(msg.sender, userAmountTokens); // Emit event
        }
&nbsp;
        // Calculate bonus tokens
        uint256 bonusAmountEth = userContribution.effectiveAmount - userContribution.amount;
&nbsp;
        if (bonusAmountEth &gt; 0) {
            // Calculate vested bonus tokens
            uint256 vestedTokens = _vestedBonusTokens(bonusAmountEth);
            // Calculate claimable amount (vested amount minus already claimed)
            uint256 claimableTokens = vestedTokens - userContribution.claimedBonusTokens;
&nbsp;
            if (claimableTokens &gt; 0) {
                // Update user's claimed bonus tokens
                userContribution.claimedBonusTokens += claimableTokens;
&nbsp;
                token.transfer(msg.sender, claimableTokens); // Transfer bonus tokens to the user
&nbsp;
                emit BonusTokensClaimed(msg.sender, claimableTokens); // Emit event
            }
        }
    }
&nbsp;
    /**
     * @dev Internal function to calculate the number of vested bonus tokens for a user
     * @param bonusAmountEth The bonus ETH amount contributed by the user
     * @return The amount of bonus tokens that have vested
     */
    function _vestedBonusTokens(uint256 bonusAmountEth) internal view returns (uint256) {
        uint256 bonusAmountTokens = (bonusAmountEth * presaleSupply) / totalEthEffective;
&nbsp;
        if (block.timestamp &gt;= presaleVestingEndTime) {
            // All bonus tokens have vested
            return bonusAmountTokens;
        } else {
            uint256 vestingDuration = presaleVestingEndTime - presaleClaimStartTime; // Total vesting duration
            uint256 timeElapsed = block.timestamp - presaleClaimStartTime; // Time elapsed since claim start
&nbsp;
            // Calculate vested amount proportionally
            return (bonusAmountTokens * timeElapsed) / vestingDuration;
        }
    }
&nbsp;
    /**
     * @notice Fallback function to receive ETH contributions
     * Users can send ETH directly to the contract address to participate in the presale
     */
    receive() external payable {
        contribute(""); // Calls the contribute function without a signature (for public presale)
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Nov 21 2024 12:01:58 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
