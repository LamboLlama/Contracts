<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Vesting.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Vesting.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>24/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>34/34</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>31/31</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79×</span>
<span class="cline-any cline-yes">78×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity 0.8.22;
&nbsp;
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";
&nbsp;
/**
 * @title Vesting Contract
 * @dev This contract handles the vesting of tokens for team members or other beneficiaries.
 * Tokens are released gradually over a specified duration, starting at a defined time.
 * The owner can configure the vesting schedules before locking the contract configuration.
 */
contract Vesting is Ownable {
    /// @dev Structure to store vesting schedule information for each beneficiary
    struct VestingSchedule {
        uint256 totalAmount; // Total number of tokens to be vested
        uint256 claimedAmount; // Amount of tokens already claimed by the beneficiary
        uint256 start; // Timestamp when vesting starts
        uint256 duration; // Duration over which vesting occurs (in seconds)
    }
&nbsp;
    /// @dev Flag to indicate if the vesting schedule has been finalized
    bool public configuratedAndFixed;
&nbsp;
    /// @dev The ERC20 token to be vested
    IERC20 public token;
&nbsp;
    /// @dev Mapping of beneficiary addresses to their corresponding vesting schedules
    mapping(address =&gt; VestingSchedule) public vestingSchedules;
&nbsp;
    /// @dev Event emitted when tokens are claimed by a beneficiary
    event TokensClaimed(address indexed beneficiary, uint256 amount);
&nbsp;
    // Custom errors for more gas-efficient error handling
    error ZeroTokenAddress(); // Thrown when a zero address is provided for the token
    error ZeroBeneficiaryAddress(); // Thrown when a zero address is provided for the beneficiary
    error ZeroTotalAmount(); // Thrown when zero total amount is provided for vesting
    error ZeroDuration(); // Thrown when zero duration is provided for vesting
    error VestingNotStarted(); // Thrown when attempting to claim tokens before vesting start
    error NoTokensToClaim(); // Thrown when there are no tokens to claim
    error ContractFixed(); // Thrown when trying to modify the contract after it is fixed
    error WithdrawVestingTokenNotAllowed(); // Thrown when attempting to withdraw the vesting token
&nbsp;
    /**
     * @dev Constructor to initialize the contract with the ERC20 token to be vested
     * @param token_ The ERC20 token address that will be vested
     */
    constructor(IERC20 token_) {
        if (address(token_) == address(0)) revert ZeroTokenAddress(); // Ensure the token address is valid
        token = token_; // Set the token to be vested
    }
&nbsp;
    /// @dev Modifier to allow certain actions only before the vesting configuration is locked
    modifier onlyBeforeConfiguratedAndFixed() {
        if (configuratedAndFixed) revert ContractFixed(); // Prevent modifications if the contract is locked
        _;
    }
&nbsp;
    /**
     * @dev Locks the contract configuration, preventing further changes to vesting schedules
     */
    function fix() external onlyOwner {
        configuratedAndFixed = true; // Set the configuration as fixed
    }
&nbsp;
    /**
     * @dev Withdraws all tokens from the contract before the configuration is locked
     * Can only be called by the owner before the contract is fixed
     */
    function withdraw() external onlyOwner onlyBeforeConfiguratedAndFixed {
        token.transfer(msg.sender, token.balanceOf(address(this))); // Transfer all tokens to the owner
    }
&nbsp;
    /**
     * @dev Withdraws any ERC20 tokens that are accidentally sent to the contract, except for the vesting token
     * @param token_ The address of the ERC20 token to withdraw
     */
    function withdrawStuckERC20(IERC20 token_) external onlyOwner {
        if (address(token_) == address(token)) revert WithdrawVestingTokenNotAllowed(); // Prevent withdrawing the vesting token
        token_.transfer(msg.sender, token_.balanceOf(address(this))); // Transfer the specified token to the owner
    }
&nbsp;
    /**
     * @dev Sets the vesting schedule for a specific beneficiary
     * Can only be called by the owner before the contract is fixed
     * @param beneficiary_ The address of the beneficiary
     * @param totalAmount_ The total amount of tokens to be vested for the beneficiary
     * @param start_ The start time (timestamp) for vesting
     * @param duration_ The duration over which the vesting occurs (in seconds)
     */
    function setVestingSchedule(
        address beneficiary_,
        uint256 totalAmount_,
        uint256 start_,
        uint256 duration_
    ) external onlyOwner onlyBeforeConfiguratedAndFixed {
        if (beneficiary_ == address(0)) revert ZeroBeneficiaryAddress(); // Ensure a valid beneficiary address
        if (totalAmount_ == 0) revert ZeroTotalAmount(); // Ensure a valid total amount of tokens
        if (duration_ == 0) revert ZeroDuration(); // Ensure a valid vesting duration
&nbsp;
        // Set the vesting schedule for the beneficiary
        vestingSchedules[beneficiary_] = VestingSchedule({
            totalAmount: totalAmount_,
            claimedAmount: 0, // Initially, no tokens have been claimed
            start: start_, // Set the start time for vesting
            duration: duration_ // Set the vesting duration
        });
    }
&nbsp;
    /**
     * @dev Allows a beneficiary to claim their vested tokens
     * The amount of claimable tokens depends on the elapsed time and the vesting schedule
     */
    function claimTokens() external {
        VestingSchedule storage schedule_ = vestingSchedules[msg.sender]; // Get the vesting schedule for the caller
&nbsp;
        if (block.timestamp &lt;= schedule_.start) revert VestingNotStarted(); // Ensure vesting has started
&nbsp;
        uint256 elapsedTime_ = block.timestamp - schedule_.start; // Calculate elapsed time since vesting started
&nbsp;
        // If the elapsed time exceeds the vesting duration, cap it to the duration
        if (elapsedTime_ &gt; schedule_.duration) {
            elapsedTime_ = schedule_.duration;
        }
&nbsp;
        // Calculate the total vested amount based on the elapsed time
        uint256 vestedAmount_ = (schedule_.totalAmount * elapsedTime_) / schedule_.duration;
        uint256 claimableAmount_ = vestedAmount_ - schedule_.claimedAmount; // Calculate claimable tokens
&nbsp;
        if (claimableAmount_ == 0) revert NoTokensToClaim(); // Ensure there are tokens to claim
&nbsp;
        // Update the claimed amount and transfer tokens to the caller
        schedule_.claimedAmount += claimableAmount_;
        token.transfer(msg.sender, claimableAmount_);
&nbsp;
        // Emit an event for the token claim
        emit TokensClaimed(msg.sender, claimableAmount_);
    }
&nbsp;
    /**
     * @dev Returns the number of claimable tokens for a given beneficiary at the current time
     * @param beneficiary_ The address of the beneficiary
     * @return The amount of claimable tokens
     */
    function getClaimableAmount(address beneficiary_) external view returns (uint256) {
        VestingSchedule storage schedule_ = vestingSchedules[beneficiary_]; // Get the vesting schedule for the beneficiary
&nbsp;
        if (block.timestamp &lt;= schedule_.start) {
            return 0; // If vesting hasn't started, there are no claimable tokens
        }
&nbsp;
        uint256 elapsedTime_ = block.timestamp - schedule_.start; // Calculate the elapsed time since vesting started
&nbsp;
        // If the elapsed time exceeds the vesting duration, cap it to the duration
        if (elapsedTime_ &gt; schedule_.duration) {
            elapsedTime_ = schedule_.duration;
        }
&nbsp;
        // Calculate the total vested amount based on the elapsed time
        uint256 vestedAmount_ = (schedule_.totalAmount * elapsedTime_) / schedule_.duration;
&nbsp;
        // Return the claimable amount (vested amount minus claimed amount)
        return vestedAmount_ - schedule_.claimedAmount;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Nov 21 2024 13:28:36 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
